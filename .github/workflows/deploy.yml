name: Deploy Drupal Site

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Install Tailscale
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled &
          sleep 5

      # 3. Connect to Tailnet
      - name: Connect to Tailnet
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          sudo tailscale up --authkey=${TAILSCALE_AUTHKEY} --hostname=github-runner --timeout=30s
          tailscale status

      # 4. Deploy to homelab VM over SSH
      - name: Deploy via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HOMELAB_SSH_KEY }}
          SSH_USER: ${{ secrets.HOMELAB_SSH_USER }}
          SSH_HOST: ${{ secrets.HOMELAB_TAILSCALE_IP }}
        run: |
          # Configure SSH
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

          # Stream code into Drupal container and run Composer + Drush
          ssh -i ~/.ssh/id_rsa $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            cd /var/lib/docker/volumes/b2282c6f80a803f10df538171294a66031c0e7a0c4028942463fc7564b75be95/_data

            echo "Streaming latest code into container..."
            tar czf - ./ | docker exec -i homesite tar xzf - -C /var/www/html

            echo "Running Composer install..."
            docker exec -i homesite composer install --no-interaction --prefer-dist

            echo "Importing Drupal config..."
            docker exec -i homesite drush cim -y

            echo "Running database updates..."
            docker exec -i homesite drush updb -y

            echo "Clearing cache..."
            docker exec -i homesite drush cr

            echo "âœ… Deployment complete."
          EOF
