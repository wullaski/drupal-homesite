name: Deploy Drupal Site

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Install Tailscale
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled &
          sleep 5

      # 3. Connect to Tailnet
      - name: Connect to Tailnet
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          sudo tailscale up --authkey=${TAILSCALE_AUTHKEY} --hostname=github-runner --timeout=30s
          tailscale status

      # 4. Prepare SSH connection
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HOMELAB_SSH_KEY }}
          SSH_USER: ${{ secrets.HOMELAB_SSH_USER }}
          SSH_HOST: ${{ secrets.HOMELAB_TAILSCALE_IP }}
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
          echo "âœ… SSH key setup complete"

      # 5. Deploy Drupal via SSH + rsync
      - name: Deploy Drupal
        env:
          SSH_USER: ${{ secrets.HOMELAB_SSH_USER }}
          SSH_HOST: ${{ secrets.HOMELAB_TAILSCALE_IP }}
        run: |
          echo "ðŸš€ Deploying Drupal code..."

          # Install rsync if missing
          echo "ðŸ”§ Checking for rsync on remote host..."
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "command -v rsync >/dev/null 2>&1 || (sudo apt-get update -qq && sudo apt-get install -y rsync)"

          # Copy updated code to host temp dir
          echo "--- Copying code to host ---"
          rsync -az --delete --exclude '.git' --exclude '.github' ./ $SSH_USER@$SSH_HOST:/opt/drupal_deploy_tmp

          # Move files into live directory and run deployment
          ssh $SSH_USER@$SSH_HOST << 'EOF'
            set -e
            echo "--- Moving code into live Drupal volume ---"
            sudo rsync -a --delete /opt/drupal_deploy_tmp/ /opt/drupal/

            echo "--- Running deployment steps inside container ---"
            docker exec -i homesite bash -c "
              cd /opt/drupal && \
              apt-get update -qq && apt-get install -y unzip apache2-utils && \
              composer clear-cache && \
              composer config --no-plugins allow-plugins.drupal/core-composer-scaffold true && \
              composer install --no-interaction --prefer-dist --no-dev && \
              chown -R www-data:www-data /opt/drupal && \
              find /opt/drupal -type d -exec chmod 755 {} \; && \
              find /opt/drupal -type f -exec chmod 644 {} \; && \
              drush cim -y && drush updb -y && drush cr
            "

            echo "--- Restarting container ---"
            docker restart homesite
            echo "âœ… Deployment complete and container restarted."
          EOF

      # 6. Clean up Tailscale session
      - name: Disconnect Tailscale
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up Tailscale..."
          sudo tailscale logout || true
          sudo tailscale down || true
          echo "âœ… Tailscale session ended."
