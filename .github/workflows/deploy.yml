name: Deploy Drupal Site

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Install Tailscale
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled &
          sleep 5

      # 3. Connect to Tailnet
      - name: Connect to Tailnet
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          sudo tailscale up --authkey=${TAILSCALE_AUTHKEY} --hostname=github-runner --timeout=30s
          tailscale status

      # 4. Verify Tailscale connectivity and setup SSH
      - name: Test Tailscale connectivity
        env:
          SSH_HOST: ${{ secrets.HOMELAB_TAILSCALE_IP }}
        run: |
          echo "üîç Testing connectivity to homelab server..."
          echo "Target host: $SSH_HOST"
          
          # Test basic connectivity
          if ping -c 3 -W 5 $SSH_HOST; then
            echo "‚úÖ Ping successful to $SSH_HOST"
          else
            echo "‚ùå Ping failed to $SSH_HOST"
            echo "Available Tailscale peers:"
            tailscale status
            exit 1
          fi

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.HOMELAB_SSH_KEY }}
          SSH_USER: ${{ secrets.HOMELAB_SSH_USER }}
          SSH_HOST: ${{ secrets.HOMELAB_TAILSCALE_IP }}
        run: |
          echo "üîß Setting up SSH connection..."
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          echo "üîç Scanning for host keys (timeout: 10s)..."
          if timeout 10 ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts 2>/dev/null; then
            echo "‚úÖ Host key scan successful"
          else
            echo "‚ö†Ô∏è  Host key scan failed, adding host to known_hosts with StrictHostKeyChecking=no"
            echo "Host $SSH_HOST" >> ~/.ssh/config
            echo "  StrictHostKeyChecking no" >> ~/.ssh/config
            echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
          fi
          
          echo "üß™ Testing SSH connection..."
          if ssh -o ConnectTimeout=10 -o BatchMode=yes $SSH_USER@$SSH_HOST 'echo "SSH connection successful"'; then
            echo "‚úÖ SSH connection test passed"
          else
            echo "‚ùå SSH connection test failed"
            echo "SSH config:"
            cat ~/.ssh/config || echo "No SSH config found"
            exit 1
          fi
          
          echo "‚úÖ SSH key setup complete"

      # 5. Copy code to host
      - name: Copy Drupal code
        timeout-minutes: 5
        run: |
          echo "üöÄ Copying Drupal code to homelab..."
          rsync -az --timeout=300 --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'web/sites/default/files' \
            ./ ${{ secrets.HOMELAB_SSH_USER }}@${{ secrets.HOMELAB_TAILSCALE_IP }}:/home/${{ secrets.HOMELAB_SSH_USER }}/drupal-deploy

      # 6. Deploy Drupal via Docker Compose
      - name: Deploy Drupal
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_ROOT_PASSWORD: ${{ secrets.DB_ROOT_PASSWORD }}
          DRUPAL_HASH_SALT: ${{ secrets.DRUPAL_HASH_SALT }}
        with:
          host: ${{ secrets.HOMELAB_TAILSCALE_IP }}
          username: ${{ secrets.HOMELAB_SSH_USER }}
          key: ${{ secrets.HOMELAB_SSH_KEY }}
          timeout: 15m
          envs: DB_NAME,DB_USER,DB_PASSWORD,DB_ROOT_PASSWORD,DRUPAL_HASH_SALT

          script: |
            set -e
            echo "Starting Docker Compose deployment..."
            
            cd ~/drupal-deploy
            
            # Create .env file for docker-compose
            cat > .env << ENVEOF
            DB_NAME=$DB_NAME
            DB_USER=$DB_USER
            DB_PASSWORD=$DB_PASSWORD
            DB_ROOT_PASSWORD=$DB_ROOT_PASSWORD
            DRUPAL_HASH_SALT=$DRUPAL_HASH_SALT
            IS_DOCKER_DEPLOYMENT=true
            ENVEOF
            
            echo "üì¶ Building and starting containers..."
            docker compose down
            
            # Build with less verbose output
            export BUILDKIT_PROGRESS=plain
            docker compose build --quiet 2>&1 | tail -n 50
            docker compose up -d
            
            echo "‚è≥ Waiting for services to be ready..."
            sleep 20
            
            echo "üì¶ Installing Composer dependencies..."
            docker compose exec -T drupal bash << 'COMPOSEREOF'
              cd /var/www/html
              composer config --no-plugins allow-plugins.drupal/core-composer-scaffold true
              composer config --no-plugins allow-plugins.drush/drush true
              composer config --no-plugins allow-plugins.composer/installers true
              composer config --no-plugins allow-plugins.drupal/core-project-message true
              composer config --no-plugins allow-plugins.php-tuf/composer-integration true
              composer config --no-plugins allow-plugins.phpstan/extension-installer true
              composer config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
              composer config --no-plugins allow-plugins.php-http/discovery true
              composer install --no-interaction --optimize-autoloader
            COMPOSEREOF
            
            echo "üîß Setting proper permissions..."
            docker compose exec -T drupal bash << 'PERMEOF'
              # Set permissions for code, but exclude the files directory (NFS mount)
              chown -R www-data:www-data /var/www/html
              find /var/www/html -path /var/www/html/web/sites/default/files -prune -o -type d -exec chmod 755 {} \;
              find /var/www/html -path /var/www/html/web/sites/default/files -prune -o -type f -exec chmod 644 {} \;
              find /var/www/html/vendor/bin -type f -exec chmod 755 {} \;
              
              # Only set ownership for files directory, don't change existing file permissions
              if [ -d /var/www/html/web/sites/default/files ]; then
                chown -R www-data:www-data /var/www/html/web/sites/default/files
                chmod 755 /var/www/html/web/sites/default
              fi
            PERMEOF
            
            echo "üîß Running Drupal updates..."
            docker compose exec -T -u root drupal bash << 'DRUSHEOF'
              cd /var/www/html
              
              # Debug: Check drush files
              echo "Checking drush installation..."
              ls -la vendor/bin/drush || echo "vendor/bin/drush not found"
              ls -la vendor/drush/drush/drush || echo "vendor/drush/drush/drush not found"
              
              # Check if Drupal is installed
              if vendor/bin/drush status --format=json 2>/dev/null | grep -q '"bootstrap":"Successful"'; then
                echo "‚úÖ Drupal bootstrap successful"
                
                # Import configuration
                echo "Importing configuration..."
                vendor/bin/drush cim -y || echo "‚ö†Ô∏è Config import failed"
                
                # Run database updates
                echo "üóÑÔ∏è Running database updates..."
                vendor/bin/drush updb -y || echo "‚ö†Ô∏è Database updates failed"
                
                # Enable and set theme
                echo "üé® Configuring theme..."
                vendor/bin/drush theme:enable simplesmart || echo "‚ö†Ô∏è Theme enable failed"
                vendor/bin/drush config:set system.theme default simplesmart -y || echo "‚ö†Ô∏è Theme set failed"
                
                # Clear caches
                echo "üßπ Clearing caches..."
                vendor/bin/drush cr
                
                echo "‚úÖ Drupal updates completed"
              else
                echo "‚ö†Ô∏è Drupal not bootstrapping - may need manual intervention"
              fi
            DRUSHEOF
            
            echo "üñºÔ∏è Clearing image cache..."
            docker compose exec -T -u root drupal bash << 'IMAGEOF'
              cd /var/www/html
              # Flush image styles to regenerate them
              vendor/bin/drush image-flush --all || echo "‚ö†Ô∏è Image flush failed"
            IMAGEOF
            
            echo "‚úÖ Deployment complete!"
            docker compose ps

      # 6. Clean up Tailscale session
      - name: Disconnect Tailscale
        if: always()
        run: |
          echo "üßπ Cleaning up Tailscale..."
          sudo tailscale logout || true
          sudo tailscale down || true
          echo "‚úÖ Tailscale session ended."
